<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zpet.ms_service.mapper.ServiceMapper">

    <!-- SELECT -->

    <select id="lastId" resultType="java.lang.Integer">
        SELECT MAX(SRV_ID) FROM service
    </select>

    <select id="getAll" parameterType="map" resultType="com.zpet.ms_service.model.Service">
        SELECT 
            s.SRV_ID as id
            , s.SRV_NAME as name
            , s.SRV_DESCRIPTION as description
            , s.SRV_PRICE as price
            , s.SRV_ISAVAILABLE as isAvailable
            , AVG(r.R_STAR) as rating
        FROM service s
        LEFT JOIN rate r ON r.SRV_ID = s.SRV_ID
        WHERE s.SRV_ISAVAILABLE = 1
        <if test="name != null">
            AND s.SRV_NAME LIKE #{name}
        </if>
        <if test="id != null">
            AND s.SRV_ID = #{id}
        </if>
        <if test="isAvailable != null">
            AND s.SRV_ISAVAILABLE = #{isAvailable}
        </if>
         <if test="fromPrice != null">
            AND s.SRV_PRICE BETWEEN #{fromPrice} AND #{toPrice}
        </if>
         GROUP BY s.SRV_ID
    </select>
    
    <select id="getRate" parameterType="java.lang.Integer" resultType="com.zpet.ms_service.model.Rate">
    	SELECT 
			r.R_ID AS id
			,r.R_STAR AS star
			,r.R_COMMENT AS comment
			,r.R_RATEDAT AS dateTime
			,r.CTM_ID AS customerId
		FROM rate r 
		JOIN service s ON s.SRV_ID = r.SRV_ID
		WHERE r.SRV_ID = ${id}            

    </select>

    <!-- INSERT -->

    <insert id="create" parameterType="com.zpet.ms_service.model.Service">
        INSERT INTO service 
        VALUES (
            #{id}
            , #{name}
            , #{description}
            , #{price}
            , #{isAvailable}
        )
    </insert>

    <!-- UPDATE -->
    <insert id="update" parameterType="com.zpet.ms_service.model.Service">
        UPDATE service 
        SET 
            SRV_NAME = ${name}
            , SRV_DESCRIPTION = ${description}
            , SRV_PRICE = ${price}
            , SRV_ISAVAILABLE = #{isAvailable}
        WHERE SRV_ID = ${id}
    </insert>

</mapper>